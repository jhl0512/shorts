<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="youtube_sample_globals.css" rel="stylesheet"/>
  <link href="yotuube_sample.css" rel="stylesheet"/>
  <style>
    .video { position: relative; overflow: hidden; }
    .video video.video-bg {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover; z-index: 0;
      pointer-events: none;
    }
    .video > * { position: relative; z-index: 1; }
    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    #container {
      height: 100vh; overflow-y: auto;
      scroll-snap-type: y mandatory;
    }
    #container::-webkit-scrollbar { display: none; }
    #loading {
      text-align: center; padding: 8px;
      background: #fff; color: #333;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div id="container">
    <div class="video" id="video-template" style="display: none">
      <div class="top">
        <svg fill="none" height="25" viewBox="0 0 25 25" width="25" xmlns="http://www.w3.org/2000/svg">
          <path d="M11.458 2.60449C16.3479..." fill="white" />
        </svg>
        <svg fill="none" height="25" viewBox="0 0 25 25" width="25" xmlns="http://www.w3.org/2000/svg">
          <path d="M12.5 17.708C13.6506..." fill="white" />
        </svg>
      </div>
      <div class="body">
        <div class="left">
          <div class="id">
            <div class="ellipse"></div>
            <div class="id-text"></div>
          </div>
          <p class="title-text"></p>
          <div class="music">
            <svg fill="none" height="20" viewBox="0 0 19 20" width="19" xmlns="http://www.w3.org/2000/svg">
              <path d="M14.25 13.167L14.2373..." fill="white" />
            </svg>
            <div class="music-text"></div>
            <div class="rectangle-1"></div>
          </div>
        </div>
        <div class="right">
          <button class="button">LIKE</button>
          <button class="button">싫어요</button>
          <button class="button">999</button>
          <button class="button">관심없음</button>
          <div class="rectangle"></div>
        </div>
      </div>
    </div>
    <div id="loading">로딩 중...</div>
  </div>

  <script>
    const container = document.getElementById('container');
    const loading = document.getElementById('loading');
    const template = document.getElementById('video-template');

    function createPost(data) {
      const post = template.cloneNode(true);
      post.style.display = 'block';

      const bg = document.createElement('video');
      bg.className = 'video-bg';
      bg.src = data['MP4 URL'];
      bg.autoplay = true;
      bg.loop = true;
      bg.playsInline = true;
      bg.muted = true;
      post.prepend(bg);

      post.querySelector('.id-text').textContent = data['ID'];
      post.querySelector('.title-text').textContent = data['TITLE'];
      post.querySelector('.music-text').textContent = data['MUSIC'];
      return post;
    }

    async function loadAll() {
      try {
        const res = await fetch("./rumbling.json");
        if (!res.ok) throw new Error('rumbling.json 로드 실패');
        const json = await res.json();
        json.forEach(row => {
          const post = createPost(row);
          container.appendChild(post);
        });
        updateAudio();
      } catch (err) {
        console.error(err);
        loading.textContent = '데이터를 불러오지 못했습니다.';
      }
      loading.style.display = 'none';
    }

    let isScrolling = false;
    container.addEventListener('wheel', (e) => {
      e.preventDefault();
      if (isScrolling) return;
      isScrolling = true;

      const direction = e.deltaY > 0 ? 1 : -1;
      const videos = [...container.querySelectorAll('.video')];
      const currentScroll = container.scrollTop;
      const viewHeight = container.clientHeight;

      let currentIndex = videos.findIndex(v => Math.abs(v.offsetTop - currentScroll) < viewHeight / 2);
      if (currentIndex === -1) currentIndex = Math.round(currentScroll / viewHeight);
      let targetIndex = Math.max(0, Math.min(videos.length - 1, currentIndex + direction));

      container.scrollTo({ top: videos[targetIndex].offsetTop, behavior: 'smooth' });

      setTimeout(() => {
        isScrolling = false;
        updateAudio();
      }, 600);
    }, { passive: false });

    container.addEventListener('scroll', () => {
      clearTimeout(container._scrollTimeout);
      container._scrollTimeout = setTimeout(updateAudio, 200);
    });

    function updateAudio() {
      const videos = document.querySelectorAll('.video');
      const containerRect = container.getBoundingClientRect();
      videos.forEach(video => {
        const rect = video.getBoundingClientRect();
        const videoEl = video.querySelector('video');
        const fullyVisible = rect.top >= containerRect.top && rect.bottom <= containerRect.bottom;
        if (videoEl) {
          videoEl.muted = !fullyVisible;
          if (fullyVisible) videoEl.play();
          else videoEl.pause();
        }
      });
    }

    loadAll();
  </script>
</body>
</html>
